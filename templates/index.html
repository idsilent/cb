<!DOCTYPE html>
<html>
<head>
    <title>可转债投资助手</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/x-icon"  href="/static/img/favicon.ico">

    <link rel="stylesheet" type="text/css" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/static/css/bootsnav.css">

    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.min.js"></script>
<!--
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?93517dc33949af1d524002310033fb5b";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
    </script>
-->
</head>
<style>
html,body {height: 100%;}

.home_banner { background: url(/static/img/bgm.jpg) top center no-repeat; background-size: cover; }

.form-signin {width: 100%;max-width: 330px;padding: 15px;margin: 0 auto;}
.form-signin .checkbox {font-weight: 400;}
.form-signin .form-control {position: relative;box-sizing: border-box;height: auto;padding: 10px;font-size: 16px;}
.form-signin .form-control:focus {z-index: 2;}
.form-signin input[type="email"] {margin-bottom: -1px;border-bottom-right-radius: 0;border-bottom-left-radius: 0;}
.form-signin input[type="password"] {margin-bottom: 10px;border-top-left-radius: 0;border-top-right-radius: 0;}

</style>
<body class=" home_banner">

<nav class="navbar navbar-default" role="navigation">
	<div class="container-fluid">
	<div class="navbar-header">
	</div>
	<div>
		<ul class="nav navbar-nav">
            <li><a href="#" onclick="process_wrapper('/realtime_update_data.html');return false">实时刷新</a></li>
            <li><a href="/view_market.html">可转债策略</a></li>
            <li><a href="/view_strategy_group.html">可转债轮动(模拟盘)</a></li>
			<li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        可转债回测
					<b class="caret"></b>
				</a>
				<ul class="dropdown-menu">
                    {% if current_user and current_user.is_authenticated %}
                    <li><a href="/view_custom_back_test.html">定制化回测</a></li>
					<li class="divider"></li>
                    {% endif %}
                    <li><a href="/view_good_year_back_test.html">行情好时的回测</a></li>
                    <li><a href="/view_bad_year_back_test.html">行情差时的回测</a></li>
                    <li><a href="/view_long_year_back_test.html">长周期下的回测</a></li>
					<li class="divider"></li>
                    <li><a href="/view_back_test_1.html">低溢价策略的回测</a></li>
                    <li><a href="/view_back_test_2.html">低余额+低溢价+双低策略的回测</a></li>
                    <li><a href="/view_back_test_3.html">低余额+双低策略的回测</a></li>
                    <li><a href="/view_back_test_4.html">低溢价+双低策略的回测</a></li>
                    <li><a href="/view_back_test_5.html">双低策略的回测</a></li>
                    <li><a href="/view_back_test_6.html">高溢价策略的回测</a></li>
                    <li><a href="/view_back_test_7.html">低价格策略的回测</a></li>
				</ul>
			</li>
            <li><a href="/view_enforce_list.html">可转债强赎</a></li>
            <li><a href="/view_trend.html">可转债估值</a></li>
			<li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        可转债分析
					<b class="caret"></b>
				</a>
				<ul class="dropdown-menu">
                    <li><a href="/view_tree_map_industry.html">行业涨跌分布</a></li>
                    <li><a href="/view_industry_premium.html">行业价格&溢价率分布</a></li>
                    <li><a href="/view_industry_double_low.html">行业双低值分布</a></li>
					<li class="divider"></li>
                    <li><a href="/view_tree_map_price.html">涨跌价格分布</a></li>
                    <li><a href="/view_tree_map_remain.html">涨跌余额分布</a></li>
                    <li><a href="/view_tree_map_premium.html">涨跌溢价率分布</a></li>
                    <li class="divider"></li>
                    <li><a href="/view_up_down_range.html">涨跌幅分布</a></li>
                    <li><a href="/view_price_range.html">价格分布</a></li>
                    <li><a href="/view_all_cb.html">全市场可转债分布</a></li>
					<li class="divider"></li>
                    <li><a href="/view_cb_wordcloud.html">可转债概念分析</a></li>
                    <li><a href="/view_hot_wordcloud.html">可转债热度分析</a></li>
					<li class="divider"></li>
                    <li><a href="/view_up_down.html">涨跌排行</a></li>
                    <li><a href="/view_discount.html">溢价率折价排行</a></li>
                    <li><a href="/view_stock.html">正股涨幅排行</a></li>
                    <li><a href="/view_turnover.html">换手率排行</a></li>
				</ul>
			</li>
            {% if current_user and current_user.is_authenticated %}
			<li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">我的自选

					<b class="caret"></b>
				</a>
				<ul class="dropdown-menu">
					<li><a href="/view_my_select.html">自选列表</a></li>
                    <li><a href="/edit_changed_bond_select.html">添加自选</a></li>
				</ul>
			</li>
			<li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">我的持仓

					<b class="caret"></b>
				</a>
				<ul class="dropdown-menu">
                    <li><a href="/view_my_strategy.html">按策略统计</a></li>
                    <li><a href="/view_my_account.html">按账户统计</a></li>
                    <li class="divider"></li>
                    <li><a href="/new_sync_trade_data.html">同步交易数据</a></li>
                    <!--                        <li><a href="/edit_hold_bond.html">更新持仓数据</a></li>-->
                    <li class="divider"></li>
                    <li><a href="/view_my_up_down.html">可转债涨跌排行</a></li>
                    <li><a href="/view_my_price_list.html">可转债价格排行</a></li>
                    <li class="divider"></li>
                    <li><a href="/view_my_yield.html">我的收益率</a></li>
                    <li><a href="/view_my_trade_history.html">我的成交记录</a></li>
				</ul>
			</li>
			<li class="dropdown">
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">系统管理

					<b class="caret"></b>
				</a>
				<ul class="dropdown-menu">
                    <li><a href="#" onclick="process_wrapper('/update_data_before_trade_is_start.html');return false">开盘前更新数据</a></li>
                    <li><a href="#" onclick="process_wrapper('/update_data_after_trade_is_end.html');return false">收盘后更新数据</a></li>
                    <li class="divider"></li>
                    <li><a href="#" onclick="process_wrapper('/init_strategy_groups.html');return false">初始化轮动模拟盘</a></li>
                    <li class="divider"></li>
                    <li><a href="#" onclick="process_wrapper('/cb_ninwen.html');return false">更新所有可转债数据</a></li>
                    <li class="divider"></li>
                    <li><a href="#" onclick="process_task('更新可转债条款明细', '/cb_ninwen_detail.html/update_terms/');return false">更新可转债条款明细</a></li>
                    <li><a href="#" onclick="process_task('更新诊断信息', '/stock_10jqka.html/update_diagnostic/');return false">同步同花顺正股诊断数据</a></li>
                    <li><a href="#" onclick="process_task('更新正股信息', '/update_stock_key_info_from_eastmoney.html/update_stock/');return false">同步东财正股关键指标</a></li>
                    <li><a href="#" onclick="process_task('更新概念信息', '/update_stock_theme_from_eastmoney.html/update_theme/');return false">同步东财正股概念信息</a></li>
                    <li><a href="#" onclick="process_task('更新财报信息', '/stock_xueqiu.html/update_stock_report/');return false">同步雪球正股财报指标</a></li>
					<li class="divider"></li>
                    <li><a href="/upload_db_data.html">数据导入</a></li>
                    <li><a href="/download_db_data.html">数据导出</a></li>
                    <li class="divider"></li>
                    <li><a href="/upload_cb_daily_data.html">历史数据导入</a></li>
                    <li><a href="/download_cb_daily_data.html">历史数据导出</a></li>
					<li class="divider"></li>
                    <li><a href="/update_database.html">修改数据</a></li>
                    <li><a href="/query_database.html">查询数据</a></li>
				</ul>
			</li>
            <li><a href="/logout.html">退&nbsp;&nbsp;&nbsp;&nbsp;出</a></li>
            {% else %}
            <li><a href="/sign.html">登&nbsp;&nbsp;&nbsp;&nbsp;录</a></li>
            {% endif %}
		</ul>
	</div>
	</div>
</nav>
{% if current_user is undefined or not current_user.is_authenticated and sign%}
    <main role="main">
        <form class="form-signin" action="/login.html" method="post" style="color: white">
          <h1 class="h3 mb-3 font-weight-normal">Please sign in</h1>
          <label for="inputUsername" class="sr-only">UserName</label>
          <input type="text" id="inputUsername" name="username" class="form-control" placeholder="UserName" required autofocus><br/>
          <label for="inputPassword" class="sr-only">Password</label>
          <input type="password" id="inputPassword" name="password" class="form-control" placeholder="Password" required>
          <div class="checkbox mb-3">
            <label>
              <input type="checkbox" value="remember-me"> Remember me
            </label>
          </div>
          <button class="btn btn-lg btn-primary btn-block" type="submit" style="background-color: #4cae4c">Sign in</button>
        </form>
    </main>
{% else %}
    <div style="text-align: center;color: white;height: 200px;width: 300px;display: block;margin: 0 auto;font-size: 15px">
        <table border="0" style="text-align: left">
            <thead>
            <tr>
                <td colspan="2" style="text-align: center;font-size: 16px;font-weight: bold">常访问网址列表</td>
            </tr>
            </thead>
            <tbody style="height: 150px">
            <tr>
                <td>&nbsp;&nbsp;1.&nbsp;&nbsp;</td>
                <td>&nbsp;&nbsp;<a href = 'https://www.jisilu.cn/data/cbnew/cb_index/' target = '_blank' style="color: white">集思录可转债等权指数统计信息</a>&nbsp;&nbsp;</td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;2.</td>
                <td>&nbsp;&nbsp;<a href = 'http://www.ninwin.cn/index.php?m=cb&c=idx' target = '_blank' style="color: white">宁稳网可转债等权指数统计信息</a></td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;3.</td>
                <td>&nbsp;&nbsp;<a href = 'https://xueqiu.com/P/ZH1332574' target = '_blank' style="color: white">yyb凌波可转债轮动策略</a></td>
            </tr>
            <tr>
                <td>&nbsp;&nbsp;4.</td>
                <td>&nbsp;&nbsp;<a href = 'https://ww2.ezhai.net.cn/#/basedata_v1_1' target = '_blank' style="color: white">pxling多因子策略数据</a></td>
            </tr>
            </tbody>
        </table>




    </div>

    <!-- Modal HTML -->
    <div id="myModal" class="modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop='static'>
        <div class="modal-dialog" style='width:300px;'>
            <div class="modal-content">
                <div class="modal-body" id = 'dialog_body'>
                    操作成功
                </div>
                <div class="modal-footer" style = 'text-align:center'>
                    <button type="button" class="btn btn-default" data-dismiss="modal" id = 'btn_close'>关闭
                    </button>

                </div>
            </div>
        </div>
    </div>


    <!-- Modal -->
    <div class="modal fade" id="processing" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop='static' >
        <div class="vertical-alignment-helper">
            <div class="modal-dialog vertical-align-center" role="document" style="width:300px">
                <div class="modal-content">
                    <div class="modal-body">
                        <img src="/static/img/processing.gif">处理中, 请稍后...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="task_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" data-backdrop='static' >
        <div class="vertical-alignment-helper">
            <div class="modal-dialog vertical-align-center" role="document" style="width:400px">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                        <h5 class="modal-title" id="myModalLabel"></h5>
                    </div>
                    <div class="modal-body">
                        <div class="progress progress-striped active">
                            <div class="progress-bar progress-bar-success" role="progressbar"
                                 aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                                 style="width: 0%;">
                                <span class="sr-only">0% 完成</span>
                            </div>
                        </div>
                        <h6 class="modal-title" id="myModalBody">当前任务处理中...</h6>
                    </div>
                    <div class="modal-footer" style = 'text-align:center'>
                        <button type="button" class="btn btn-default" data-dismiss="modal" id = 'btn_close_task'>关&nbsp;&nbsp;闭
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
<style>
    .vertical-alignment-helper {
        display:table;
        height: 100%;
        width: 100%;
        pointer-events:none; /* This makes sure that we can still click outside of the modal to close it */
    }
    .vertical-align-center {
        /* To center vertically */
        display: table-cell;
        vertical-align: middle;
        pointer-events:none;
    }
    .modal-content {
        /* Bootstrap sets the size of the modal in the modal-dialog class, we need to inherit it */
        width:inherit;
        max-width:inherit; /* For Bootstrap 4 - to avoid the modal window stretching full width */
        height:inherit;
        /* To center horizontally */
        margin: 0 auto;
        pointer-events: all;
    }
</style>
<script type="text/javascript">
    $(document).ready(function(){
        function alignModal(){
            var modalDialog = $(this).find(".modal-dialog");
            /* Applying the top margin on modal dialog to align it vertically center */
            modalDialog.css("margin-top", Math.max(0, ($(window).height() - modalDialog.height()) / 2));

        }
        // Align modal when it is displayed
        $(".modal").on("shown.bs.modal", alignModal);

        // Align modal when user resize the window
        $(window).on("resize", function(){
            $(".modal:visible").each(alignModal);
        });
    });

    function doCallback(data, status) {
        if (status == 'success' && data == 'OK'){
            // alert('body begin')
            $('#dialog_body').text('操作成功!');
            // alert('body end')
        }else{
            $('#dialog_body').html('<p style=\'color: red\'>后端异常, 操作失败, 请检查后台日志或稍后重试!</p>')
        }
        $('#myModal').modal('show');
        $('#btn_close').focus()
        document.body.style.cursor = ''
    }

    function process(url) {
        var defer = $.Deferred();
        $.ajax({
            url:url,
            success: function (data, status) {
                defer.resolve({'data':data, 'status':status})
            },
            error: function (data, status) {
                defer.resolve({'data':data, 'status':status})
            }
        });
        return defer.promise()
    }

    function process_wrapper(url) {
        document.body.style.cursor = 'wait'
        $('#processing').modal('show')

        $.when(process(url)).done(function (return_value) {
            $('#processing').modal('hide')
            doCallback(return_value['data'], return_value['status'])
        });
    }

    function process_task(title, url) {
        // 调用异步处理后台程序
        $.get(url);

        ss = url.split('/')
        task_name = ss[ss.length-2]

        // 查看当前任务处理状态, 初始化进度条
        timer = window.setInterval(function () {
                $.ajax({
                url:"/get_task_data.html/" + task_name + "/",
                dataType: 'json',
                success: function (data) {

                    if (data['process'] == 100 || $("#task_modal").css('display') == 'none') { // 任务完成或进度弹窗关闭, 终止轮询
                        window.clearInterval(timer)
                    }
                    $(".progress-bar").css('width', data['process'] + '%')
                    if (data['status'] == -1 || data['status'] == 1) { // 任务结束(失败or结束), 给出提示信息

                        if (data['status'] == -1) { // 失败, 红色警告
                            $('.progress-bar').removeClass('progress-bar-success');
                            $('.progress-bar').addClass('progress-bar-danger');
                            $('#myModalBody').text("任务处理中断. " + data['desc']);
                        } else {
                            $('#myModalBody').text("任务处理完成. " + data['desc']);
                            window.clearInterval(timer)
                        }
                    } else {
                        $('.progress-bar').removeClass('progress-bar-danger');
                        $('.progress-bar').addClass('progress-bar-success');
                        $('#myModalBody').text("当前任务处理中("+ data['current_num'] + "/" + data['total_num'] +")...")
                    }
                },
                error: function (data) {
                    alert("get_task_data occur error:" + data)
                }
            })
        }, 3000)
        $('#myModalLabel').text(title)
        $(".progress-bar").css('width', '0%')
        $('#myModalBody').text("");
        $('#task_modal').modal('show')
        // 轮询后台task表, 根据更新进度更新进度条
        // 后台处理异常, 进度条换颜色(红色), 并提示异常信息
    }
</script>
{% endif %}

</body>
</html>
